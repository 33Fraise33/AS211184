{% if route_filtering is defined %}
! PREFIX LISTS
{%  for pl in route_filtering.prefix_lists|default() %}
!!!!! {{ pl.name }}
{%    for entry in pl.lists %}
ip prefix-list {{ pl.name }} {{ entry.policy|default('permit') }} {{ entry.prefix }}
{%- if entry.le is defined %} le {{ entry.le }}{% endif %}
{%- if entry.ge is defined %} ge {{ entry.ge }}{% endif %}

{%    endfor %}
{%  endfor %}
! COMMUNITIES
{%  for com_name, com in bgp_communities.items() %}
!!!!! {{ com_name }}
bgp large-community-list {{ com.type|default('standard') }} {{ com_name }} {{ com.policy|default('permit') }} {{ com.community }}
{%  endfor %}
!
! ROUTE MAPS
{%  for rm in route_filtering.route_maps|default() %}
!!!!! {{ rm.name }}
{%    for entry in rm.maps %}
route-map {{ rm.name }} {{ entry.policy|default('permit') }} {{ (loop.index * 10) }}
{%      if entry.match.v4_prefix_list is defined %}
 match ip address prefix-list {{ entry.match.v4_prefix_list }}
{%      endif %}
{%      if entry.match.v6_prefix_list is defined %}
 match ipv6 address prefix-list {{ entry.match.v6_prefix_list }}
{%      endif %}
{%      if entry.match.community is defined %}
 match community {{ entry.match.community }}
{%      endif %}
{%      if entry.match.large_community is defined %}
 match large-community {{ entry.match.large_community }}
{%      endif %}
{%      if entry.action is defined %}
{%          if entry.action.set is defined %}
{%              if entry.action.set.next_hop is defined %}
 set ip next-hop {{ entry.action.set.next_hop }}
{%              endif %}
{%              if entry.action.set.prepend is defined %}
 set as-path prepend {{ entry.action.set.prepend|join(" ") }}
{%              endif %}
{%              for comm in entry.action.set.large_communities|default([]) %}
 set large-community {{ bgp_communities[comm].community }} additive
{%              endfor %}
{%          endif%}
{%          if entry.action.on_match is defined %}
 on-match {{ entry.action.on_match }}
{%          endif%}
{%          if entry.action.call is defined %}
 call {{ entry.action.call }}
{%          endif%}
{%      endif %}
{%    endfor %}
{%  endfor %}
{% endif %}